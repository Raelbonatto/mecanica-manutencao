<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Planejamento de Manuten√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --line:#1f2937; --muted:#93a3b8;
      --text:#e5e7eb; --accent:#38bdf8; --danger:#ef4444; --ok:#22c55e;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      background:linear-gradient(180deg,#0b1220,#0b1220 30%,#0d1525); color:var(--text);
    }
    a{ color:var(--text); text-decoration:none; }
    header{
      position:sticky; top:0; background:#0f172a; border-bottom:1px solid var(--line);
      padding:12px 18px; display:flex; align-items:center; justify-content:space-between; z-index:10;
    }
    .title{ font-weight:700; letter-spacing:.4px; }
    .hdr-actions{ display:flex; gap:8px; align-items:center; }
    .btn{
      background:#111827; border:1px solid #1f2937; color:#e5e7eb; padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn.primary{ border-color:#0ea5e9; color:#e6f9ff; box-shadow:0 0 0 1px #0ea5e9 inset; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .grid{ display:grid; gap:18px; }
    .panel{ background:#0f172a; border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .panel h2{ margin:0; padding:12px 16px; border-bottom:1px solid var(--line); font-size:18px; }
    .content{ padding:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
    label{ display:block; color:#cbd5e1; font-size:12px; margin-bottom:6px; }
    input, select, textarea{
      background:#0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; min-width:220px;
    }
    textarea{ width:100%; resize:vertical; }
    .two{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px; }
    @media (max-width:900px){ .two{ grid-template-columns:1fr; } }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:12px 14px; border-bottom:1px solid var(--line); text-align:left; }
    thead th{ position:sticky; top:0; background:#0f172a; z-index:1; color:#cbd5e1; }
    tr.late{ background:#3b0d0d; }
    .muted{ color:#93a3b8; }
    .kpis{ display:grid; gap:14px; grid-template-columns:repeat(3,minmax(0,1fr)); }
    .kpi{ background:#0f172a; border:1px solid var(--line); border-radius:14px; padding:14px; display:flex; gap:12px; align-items:center; }
    .kpi .n{ font-size:32px; font-weight:800; }
    .danger{ color:#ff7b7b; }
    .ok{ color:#22c55e; }
  </style>
</head>
<body>
  <header>
    <div class="title">üóìÔ∏è Planejamento de Manuten√ß√£o</div>
    <div class="hdr-actions">
      <a class="btn" href="./cadastros.html">Cadastros</a>
      <a class="btn" href="./monitor.html">Monitoramento</a>
      <button class="btn" id="toggleListaBtn">Ver planejamentos</button>
      <button class="btn" id="exportCsvBtn">Exportar CSV</button>
    </div>
  </header>

  <div class="wrap grid">
    <!-- KPIs simples -->
    <section class="kpis">
      <div class="kpi"><div class="n" id="kTotal">0</div><div>Total</div></div>
      <div class="kpi"><div class="n danger" id="kAtrasadas">0</div><div>Atrasadas</div></div>
      <div class="kpi"><div class="n ok" id="kHoje">0</div><div>Vencem hoje</div></div>
    </section>

    <!-- Formul√°rio de Planejamento -->
    <section class="panel">
      <h2>‚úçÔ∏è Planejar nova manuten√ß√£o</h2>
      <div class="content">
        <form id="formCad" class="grid">
          <div class="two">
            <div><label>C√≥digo</label><input name="codigo" placeholder="INJ-12"></div>
            <div><label>M√°quina</label><input name="maquina" placeholder="Injetora 120T" list="listaEquip"></div>
            <datalist id="listaEquip"></datalist>
          </div>
          <div class="two">
            <div><label>Setor</label><input name="setor" placeholder="Inje√ß√£o"></div>
            <div><label>Item (servi√ßo)</label><input name="item" placeholder="Troca filtro √≥leo" list="listaServ"></div>
            <datalist id="listaServ"></datalist>
          </div>
          <div class="two">
            <div><label>O que fazer</label><input name="oque1"></div>
            <div><label>O que fazer 2</label><input name="oque2"></div>
          </div>
          <div class="two">
            <div><label>Ciclo (dias)</label><input type="number" name="ciclo" value="30"></div>
            <div><label>√öltima manuten√ß√£o</label><input type="date" name="ultima"></div>
          </div>
          <div class="two">
            <div>
              <label>Tipo</label>
              <select name="tipo" id="selectTipo">
                <option>Preventiva</option><option>Preditiva</option>
                <option>Corretiva</option><option>Melhoria</option>
              </select>
            </div>
            <div><label>Operadores (v√≠rgula)</label><input name="operadores" placeholder="Carlos,Aline" list="listaOps"></div>
            <datalist id="listaOps"></datalist>
          </div>
          <div class="two">
            <div><label>Dura√ß√£o (h)</label><input type="number" step="0.1" name="duracao" value="1.0"></div>
            <div><label>Custo material (R$)</label><input type="number" step="0.01" name="cMat" value="0"></div>
          </div>
          <div class="two">
            <div><label>Custo tempo (R$)</label><input type="number" step="0.01" name="cTempo" value="0"></div>
            <div><label>Observa√ß√µes</label><input name="obs"></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn primary">Criar programa√ß√£o</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Lista de Planejamentos (inicialmente escondida) -->
    <section class="panel" id="listaPanel" style="display:none">
      <h2>üìÑ Todos os planejamentos</h2>
      <div class="content" style="padding:0">
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>Pr√≥xima</th><th>C√≥digo</th><th>M√°quina</th><th>Setor</th>
                <th>Item</th><th>Tipo</th><th>Status</th><th>Operadores</th>
                <th>Dura√ß√£o(h)</th><th>Custo</th><th class="muted">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ======= DADOS (localStorage) =======
    const STORAGE_KEY='mecanica_planejamento_github_v1';
    const STATUS=['Planejada','Em Execu√ß√£o','Conclu√≠da'];

    const toBR = d => new Date(d).toLocaleDateString('pt-BR');
    const addDays=(iso,d)=>{ const x=new Date(iso); x.setDate(x.getDate()+d); return x.toISOString(); }
    const sameDay=(a,b)=> new Date(a).toDateString()===new Date(b).toDateString();
    const overdue=(iso)=> new Date(iso) < new Date(new Date().toDateString()+' 23:59:59');
    const fmtMoeda = v => Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

    let rows = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null') ?? [
      { id:crypto.randomUUID(), codigo:'INJ-12', maquina:'Injetora 120T', setor:'Inje√ß√£o',
        item:'Lubrifica√ß√£o eixo Z', oque1:'Lubrificar guias', oque2:'Checar folgas',
        cicloDias:30, ultima:new Date().toISOString(), proxima:addDays(new Date().toISOString(),30),
        tipo:'Preventiva', status:'Planejada', operadores:['Carlos'], duracaoHoras:1.5, custoTempo:0, custoMaterial:0, observacoes:'' }
    ];
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    // ======= CADASTROS -> datalists/select (opcional, lidos do localStorage dos cadastros) =======
    function applyMasters(){
      let m={}; try{ m = JSON.parse(localStorage.getItem('mecanica_masters_v1')||'{}'); }catch(_){}
      const equip=(m.equipamentos||[]).sort();
      const serv=(m.servicos||[]).sort();
      const ops=(m.operadores||[]).sort();
      const tipos=(m.tipos&&m.tipos.length?m.tipos:['Preventiva','Preditiva','Corretiva','Melhoria']);
      const dlE=document.getElementById('listaEquip'); if(dlE) dlE.innerHTML=equip.map(x=>`<option value="${x}">`).join('');
      const dlS=document.getElementById('listaServ');  if(dlS) dlS.innerHTML=serv.map(x=>`<option value="${x}">`).join('');
      const dlO=document.getElementById('listaOps');   if(dlO) dlO.innerHTML=ops.map(x=>`<option value="${x}">`).join('');
      const sel=document.getElementById('selectTipo'); if(sel) sel.innerHTML=tipos.map(t=>`<option>${t}</option>`).join('');
    }
    applyMasters();

    // ======= KPI =======
    function renderKpis(){
      const atras = rows.filter(r=>overdue(r.proxima) && r.status!=='Conclu√≠da').length;
      const hoje  = rows.filter(r=>sameDay(r.proxima,new Date()) && r.status!=='Conclu√≠da').length;
      document.getElementById('kTotal').textContent = rows.length;
      document.getElementById('kAtrasadas').textContent = atras;
      document.getElementById('kHoje').textContent = hoje;
    }

    // ======= LISTA =======
    function renderLista(){
      const tb=document.getElementById('tbody'); tb.innerHTML='';
      rows
        .slice()
        .sort((a,b)=> new Date(a.proxima)-new Date(b.proxima))
        .forEach(r=>{
          const tr=document.createElement('tr');
          if(overdue(r.proxima) && r.status!=='Conclu√≠da') tr.className='late';
          tr.innerHTML = `
            <td>${toBR(r.proxima)}</td>
            <td><code>${r.codigo||''}</code></td>
            <td>${r.maquina||''}</td>
            <td>${r.setor||''}</td>
            <td>${r.item||''}</td>
            <td>${r.tipo||''}</td>
            <td>${r.status||''}</td>
            <td>${(r.operadores||[]).join(', ')||'-'}</td>
            <td>${r.duracaoHoras||''}</td>
            <td>${fmtMoeda((r.custoTempo||0)+(r.custoMaterial||0))}</td>
            <td>
              <button class="btn" data-b="back">Voltar</button>
              <button class="btn" data-b="next">Avan√ßar</button>
              <button class="btn" data-b="del">Remover</button>
            </td>`;
          const [bBack,bNext,bDel]=tr.querySelectorAll('button');
          if(bBack) bBack.onclick=()=> mover(r.id,-1);
          if(bNext) bNext.onclick=()=> mover(r.id,+1);
          if(bDel)  bDel.onclick =()=> { rows=rows.filter(x=>x.id!==r.id); save(); renderKpis(); renderLista(); };
          tb.appendChild(tr);
        });
    }

    function mover(id,delta){
      const i=rows.findIndex(r=>r.id===id); if(i<0) return;
      const idx=STATUS.indexOf(rows[i].status);
      rows[i].status = STATUS[Math.max(0, Math.min(STATUS.length-1, idx+delta))];
      save(); renderKpis(); renderLista();
    }

    // ======= FORM =======
    document.getElementById('formCad').onsubmit=(e)=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const codigo=(fd.get('codigo')||'').toString().toUpperCase();
      const maquina=(fd.get('maquina')||'').toString();
      const setor=(fd.get('setor')||'').toString();
      const item=(fd.get('item')||'').toString();
      const oque1=(fd.get('oque1')||'').toString();
      const oque2=(fd.get('oque2')||'').toString();
      const cicloDias=Number(fd.get('ciclo')||30);
      const ultima=new Date(fd.get('ultima')||new Date()).toISOString();
      const proxima=addDays(ultima, cicloDias);
      const tipo=(fd.get('tipo')||'Preventiva').toString();
      const operadores=((fd.get('operadores')||'').toString().split(',').map(s=>s.trim()).filter(Boolean));
      const duracaoHoras=Number(fd.get('duracao')||1);
      const custoTempo=Number(fd.get('cTempo')||0);
      const custoMaterial=Number(fd.get('cMat')||0);
      const observacoes=(fd.get('obs')||'').toString();

      rows=[{ id:crypto.randomUUID(), codigo, maquina, setor, item, oque1, oque2, cicloDias,
              ultima, proxima, tipo, status:'Planejada', operadores, duracaoHoras, custoTempo, custoMaterial, observacoes },
            ...rows];
      save(); e.target.reset(); renderKpis();
      // abre/atualiza a lista se estiver vis√≠vel
      if(document.getElementById('listaPanel').style.display!=='none') renderLista();
      alert('Programa√ß√£o criada!');
    };

    // ======= TOGGLE LISTA =======
    const toggleBtn=document.getElementById('toggleListaBtn');
    const listaPanel=document.getElementById('listaPanel');
    toggleBtn.onclick=()=>{
      const showing = listaPanel.style.display!=='none';
      listaPanel.style.display = showing ? 'none' : 'block';
      toggleBtn.textContent = showing ? 'Ver planejamentos' : 'Ocultar planejamentos';
      if(!showing){ renderLista(); }
    };

    // ======= EXPORT CSV =======
    document.getElementById('exportCsvBtn').onclick=()=>{
      const header=["CODIGO","MAQUINA","SETOR","ITEM","OQUE1","OQUE2","CICLO_DIAS","ULTIMA","PROXIMA","TIPO","STATUS","OPERADORES","DURACAO_H","CUSTO_TEMPO","CUSTO_MATERIAL","OBS"];
      const body=rows.map(r=>[r.codigo,r.maquina,r.setor,r.item,r.oque1,r.oque2,r.cicloDias,r.ultima,r.proxima,r.tipo,r.status,(r.operadores||[]).join('/'),r.duracaoHoras,r.custoTempo,r.custoMaterial,r.observacoes]);
      const csv=[header,...body].map(line=> line.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`planejamentos_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),500);
    };

    // init
    renderKpis();
  </script>
</body>
</html>
